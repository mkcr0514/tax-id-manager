<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>統編抬頭管理系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const Search = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
            </svg>
        );

        const Plus = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 4v16m8-8H4" />
            </svg>
        );

        const Edit2 = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
        );

        const Trash2 = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
        );

        const Save = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
            </svg>
        );

        const X = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M6 18L18 6M6 6l12 12" />
            </svg>
        );

        const RefreshCw = ({ className }) => (
            <svg className={className} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
        );

        const Download = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
            </svg>
        );

        const Upload = () => (
            <svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
            </svg>
        );

        function TaxIdManager() {
            const [records, setRecords] = useState([]);
            const [searchTaxId, setSearchTaxId] = useState('');
            const [searchResult, setSearchResult] = useState(null);
            const [isSearching, setIsSearching] = useState(false);
            const [isAdding, setIsAdding] = useState(false);
            const [editingId, setEditingId] = useState(null);
            const [newRecord, setNewRecord] = useState({ taxId: '', companyName: '', note: '' });
            const [loading, setLoading] = useState(true);
            const [editForm, setEditForm] = useState({});

            useEffect(() => {
                loadRecords();
            }, []);

            const loadRecords = () => {
                try {
                    const data = localStorage.getItem('taxIdRecords');
                    if (data) {
                        const parsed = JSON.parse(data);
                        setRecords(parsed.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                    }
                } catch (error) {
                    console.error('載入失敗:', error);
                    setRecords([]);
                } finally {
                    setLoading(false);
                }
            };

            const saveRecords = (newRecords) => {
                try {
                    localStorage.setItem('taxIdRecords', JSON.stringify(newRecords));
                    setRecords(newRecords.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)));
                    return true;
                } catch (error) {
                    console.error('儲存失敗:', error);
                    alert('儲存失敗');
                    return false;
                }
            };

            const deleteRecord = (taxId) => {
                if (!confirm('確定要刪除這筆記錄嗎？')) return;
                const newRecords = records.filter(r => r.taxId !== taxId);
                saveRecords(newRecords);
                setSearchResult(null);
            };

            const queryG0vAPI = async (taxId) => {
                try {
                    const apiUrl = `https://company.g0v.ronny.tw/api/show/${taxId}`;
                    console.log('正在查詢:', apiUrl);
                    
                    const response = await fetch(apiUrl);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('API 回傳資料:', data);
                    return data;
                } catch (error) {
                    console.error('API 查詢錯誤:', error);
                    alert(`查詢失敗：${error.message}`);
                    return null;
                }
            };

            const handleSearch = async () => {
                const taxId = searchTaxId.trim();
                if (!taxId) {
                    alert('請輸入統一編號');
                    return;
                }
                
                setIsSearching(true);
                setSearchResult(null);
                
                const localRecord = records.find(r => r.taxId === taxId);
                
                if (localRecord) {
                    setSearchResult({
                        ...localRecord,
                        source: 'local'
                    });
                    setIsSearching(false);
                } else {
                    const apiData = await queryG0vAPI(taxId);
                    setIsSearching(false);
                    
                    if (apiData && apiData.data) {
                        const companyName = apiData.data.公司名稱 || apiData.data.商業名稱;
                        
                        if (companyName) {
                            const result = {
                                taxId: taxId,
                                companyName: companyName,
                                address: apiData.data.公司所在地 || apiData.data.商業所在地 || '',
                                status: apiData.data.公司狀況 || apiData.data.商業狀況 || '',
                                capital: apiData.data.資本總額 || apiData.data.資本額 || '',
                                source: 'api'
                            };
                            setSearchResult(result);
                        } else {
                            alert('查無此統編資料');
                        }
                    } else {
                        alert('查無此統編資料');
                    }
                }
            };

            const handleSaveFromSearch = () => {
                if (!searchResult) return;
                
                const record = {
                    taxId: searchResult.taxId,
                    companyName: searchResult.companyName,
                    note: searchResult.note || '',
                    address: searchResult.address || '',
                    status: searchResult.status || '',
                    capital: searchResult.capital || '',
                    createdAt: new Date().toISOString()
                };
                
                const existingIndex = records.findIndex(r => r.taxId === record.taxId);
                let newRecords;
                
                if (existingIndex >= 0) {
                    newRecords = [...records];
                    newRecords[existingIndex] = record;
                } else {
                    newRecords = [...records, record];
                }
                
                if (saveRecords(newRecords)) {
                    alert('已儲存到記錄');
                    setSearchResult({ ...record, source: 'local' });
                }
            };

            const handleAddRecord = () => {
                const taxId = newRecord.taxId.trim();
                const companyName = newRecord.companyName.trim();
                
                if (!taxId || !companyName) {
                    alert('請填寫統一編號和公司抬頭');
                    return;
                }
                
                const record = {
                    taxId,
                    companyName,
                    note: newRecord.note.trim(),
                    createdAt: new Date().toISOString()
                };
                
                const existingIndex = records.findIndex(r => r.taxId === record.taxId);
                let newRecords;
                
                if (existingIndex >= 0) {
                    newRecords = [...records];
                    newRecords[existingIndex] = record;
                } else {
                    newRecords = [...records, record];
                }
                
                if (saveRecords(newRecords)) {
                    setNewRecord({ taxId: '', companyName: '', note: '' });
                    setIsAdding(false);
                }
            };

            const startEdit = (record) => {
                setEditingId(record.taxId);
                setEditForm({ ...record });
            };

            const cancelEdit = () => {
                setEditingId(null);
                setEditForm({});
            };

            const handleUpdateRecord = () => {
                if (!editForm.companyName.trim()) {
                    alert('公司抬頭不能為空');
                    return;
                }
                
                const index = records.findIndex(r => r.taxId === editForm.taxId);
                if (index >= 0) {
                    const newRecords = [...records];
                    newRecords[index] = editForm;
                    
                    if (saveRecords(newRecords)) {
                        setEditingId(null);
                        setEditForm({});
                    }
                }
            };

            const exportData = () => {
                const dataStr = JSON.stringify(records, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `統編資料_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                URL.revokeObjectURL(url);
            };

            const importData = async (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                try {
                    const text = await file.text();
                    const importedRecords = JSON.parse(text);
                    
                    if (!Array.isArray(importedRecords)) {
                        alert('檔案格式錯誤');
                        return;
                    }
                    
                    const mergedRecords = [...records];
                    
                    importedRecords.forEach(imported => {
                        if (imported.taxId && imported.companyName) {
                            const existingIndex = mergedRecords.findIndex(r => r.taxId === imported.taxId);
                            if (existingIndex >= 0) {
                                mergedRecords[existingIndex] = imported;
                            } else {
                                mergedRecords.push(imported);
                            }
                        }
                    });
                    
                    if (saveRecords(mergedRecords)) {
                        alert(`成功匯入/更新 ${importedRecords.length} 筆資料`);
                    }
                } catch (error) {
                    console.error('匯入錯誤:', error);
                    alert('匯入失敗，請確認檔案格式正確');
                }
                
                event.target.value = '';
            };

            return (
                <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
                    <div className="max-w-6xl mx-auto">
                        <div className="text-center mb-8 pt-8">
                            <h1 className="text-4xl font-bold text-gray-800 mb-2">統編抬頭管理系統</h1>
                            <p className="text-gray-600">自動查詢 g0v 資料庫，快速管理客戶統編</p>
                        </div>

                        <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">統編查詢</h2>
                            <div className="flex gap-3">
                                <input
                                    type="text"
                                    value={searchTaxId}
                                    onChange={(e) => setSearchTaxId(e.target.value)}
                                    onKeyPress={(e) => e.key === 'Enter' && handleSearch()}
                                    placeholder="輸入統一編號（8位數字）"
                                    className="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    maxLength="8"
                                />
                                <button
                                    onClick={handleSearch}
                                    disabled={isSearching}
                                    className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 disabled:bg-gray-400"
                                >
                                    {isSearching ? (
                                        <>
                                            <RefreshCw className="w-4 h-4 animate-spin" />
                                            查詢中
                                        </>
                                    ) : (
                                        <>
                                            <Search />
                                            查詢
                                        </>
                                    )}
                                </button>
                            </div>

                            {searchResult && (
                                <div className="mt-4 p-4 bg-blue-50 rounded-lg border border-blue-200">
                                    <div className="flex items-start justify-between">
                                        <div className="flex-1">
                                            <div className="flex items-center gap-2 mb-2">
                                                <h3 className="text-lg font-semibold text-gray-800">{searchResult.companyName}</h3>
                                                <span className={`px-2 py-1 text-xs rounded-full ${
                                                    searchResult.source === 'local' 
                                                        ? 'bg-green-100 text-green-700' 
                                                        : 'bg-yellow-100 text-yellow-700'
                                                }`}>
                                                    {searchResult.source === 'local' ? '本地記錄' : 'API 查詢'}
                                                </span>
                                            </div>
                                            <p className="text-sm text-gray-600 mb-1">統一編號：{searchResult.taxId}</p>
                                            {searchResult.address && (
                                                <p className="text-sm text-gray-600 mb-1">地址：{searchResult.address}</p>
                                            )}
                                            {searchResult.status && (
                                                <p className="text-sm text-gray-600 mb-1">狀態：{searchResult.status}</p>
                                            )}
                                            {searchResult.capital && (
                                                <p className="text-sm text-gray-600 mb-1">資本額：{searchResult.capital}</p>
                                            )}
                                            {searchResult.note && (
                                                <p className="text-sm text-gray-600 mb-1">備註：{searchResult.note}</p>
                                            )}
                                        </div>
                                        {searchResult.source === 'api' && (
                                            <button
                                                onClick={handleSaveFromSearch}
                                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
                                            >
                                                <Save />
                                                儲存
                                            </button>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        <div className="flex gap-3 mb-6">
                            <button
                                onClick={() => setIsAdding(true)}
                                className="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors flex items-center gap-2"
                            >
                                <Plus />
                                新增記錄
                            </button>
                            <button
                                onClick={exportData}
                                disabled={records.length === 0}
                                className="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition-colors flex items-center gap-2 disabled:bg-gray-400"
                            >
                                <Download />
                                匯出資料
                            </button>
                            <label className="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors flex items-center gap-2 cursor-pointer">
                                <Upload />
                                匯入資料
                                <input
                                    type="file"
                                    accept=".json"
                                    onChange={importData}
                                    className="hidden"
                                />
                            </label>
                        </div>

                        {isAdding && (
                            <div className="bg-white rounded-lg shadow-lg p-6 mb-6">
                                <h2 className="text-xl font-semibold text-gray-800 mb-4">新增記錄</h2>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">統一編號 *</label>
                                        <input
                                            type="text"
                                            value={newRecord.taxId}
                                            onChange={(e) => setNewRecord({ ...newRecord, taxId: e.target.value })}
                                            placeholder="8位數字"
                                            maxLength="8"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">公司抬頭 *</label>
                                        <input
                                            type="text"
                                            value={newRecord.companyName}
                                            onChange={(e) => setNewRecord({ ...newRecord, companyName: e.target.value })}
                                            placeholder="完整公司名稱"
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-medium text-gray-700 mb-1">備註</label>
                                        <textarea
                                            value={newRecord.note}
                                            onChange={(e) => setNewRecord({ ...newRecord, note: e.target.value })}
                                            placeholder="選填"
                                            rows={2}
                                            className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                        />
                                    </div>
                                    <div className="flex gap-3">
                                        <button
                                            onClick={handleAddRecord}
                                            className="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors"
                                        >
                                            儲存
                                        </button>
                                        <button
                                            onClick={() => {
                                                setIsAdding(false);
                                                setNewRecord({ taxId: '', companyName: '', note: '' });
                                            }}
                                            className="px-6 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors"
                                        >
                                            取消
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                        <div className="bg-white rounded-lg shadow-lg p-6">
                            <h2 className="text-xl font-semibold text-gray-800 mb-4">
                                歷史記錄 ({records.length})
                            </h2>
                            
                            {loading ? (
                                <div className="text-center py-8 text-gray-500">載入中...</div>
                            ) : records.length === 0 ? (
                                <div className="text-center py-8 text-gray-500">尚無記錄</div>
                            ) : (
                                <div className="space-y-3">
                                    {records.map((record) => (
                                        <div key={record.taxId} className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                                            {editingId === record.taxId ? (
                                                <div className="space-y-3">
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">公司抬頭 *</label>
                                                        <input
                                                            type="text"
                                                            value={editForm.companyName}
                                                            onChange={(e) => setEditForm({ ...editForm, companyName: e.target.value })}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-sm font-medium text-gray-700 mb-1">備註</label>
                                                        <textarea
                                                            value={editForm.note || ''}
                                                            onChange={(e) => setEditForm({ ...editForm, note: e.target.value })}
                                                            rows={2}
                                                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500"
                                                        />
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={handleUpdateRecord}
                                                            className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2"
                                                        >
                                                            <Save />
                                                            儲存
                                                        </button>
                                                        <button
                                                            onClick={cancelEdit}
                                                            className="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors flex items-center gap-2"
                                                        >
                                                            <X />
                                                            取消
                                                        </button>
                                                    </div>
                                                </div>
                                            ) : (
                                                <div className="flex items-start justify-between">
                                                    <div className="flex-1">
                                                        <h3 className="text-lg font-semibold text-gray-800 mb-1">{record.companyName}</h3>
                                                        <p className="text-sm text-gray-600 mb-1">統一編號：{record.taxId}</p>
                                                        {record.address && (
                                                            <p className="text-sm text-gray-600 mb-1">地址：{record.address}</p>
                                                        )}
                                                        {record.note && (
                                                            <p className="text-sm text-gray-600 mb-1">備註：{record.note}</p>
                                                        )}
                                                        <p className="text-xs text-gray-400 mt-2">
                                                            建立時間：{new Date(record.createdAt).toLocaleString('zh-TW')}
                                                        </p>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button
                                                            onClick={() => startEdit(record)}
                                                            className="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-colors"
                                                            title="編輯"
                                                        >
                                                            <Edit2 />
                                                        </button>
                                                        <button
                                                            onClick={() => deleteRecord(record.taxId)}
                                                            className="p-2 text-red-600 hover:bg-red-50 rounded-lg transition-colors"
                                                            title="刪除"
                                                        >
                                                            <Trash2 />
                                                        </button>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>

                        <div className="mt-6 text-center text-sm text-gray-600">
                            <p>資料來源：g0v 統編查詢 API</p>
                            <p className="mt-1">資料儲存在瀏覽器本地（localStorage）</p>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<TaxIdManager />, document.getElementById('root'));
    </script>
</body>
</html>